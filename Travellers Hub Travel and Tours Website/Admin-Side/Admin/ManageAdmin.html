<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Table - Admin Panel</title>
    <link rel="stylesheet" href="../assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i">
    <link rel="stylesheet" href="../assets/fonts/fontawesome-all.min.css">
    <link rel="stylesheet" href="../assets/fonts/font-awesome.min.css">
    <link rel="stylesheet" href="../assets/fonts/fontawesome5-overrides.min.css">
    <link rel="stylesheet" href="../assets/css/Bootstrap-4-Calendar-No-Custom-Code.css">
    <link rel="stylesheet" href="../assets/css/Login-Form-Clean.css">
</head>

<body id="page-top">
    <!-- ... your existing content ... -->

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('token');
            if (!token) return;

            try {
                const response = await fetch('http://localhost:5001/api/auth/admins', {
                    method: 'GET',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                    },
                });

                const admins = await response.json();

                if (response.ok) {
                    const tableBody = document.querySelector('#dataTable tbody');
                    tableBody.innerHTML = ''; // Clear existing rows

                    admins.forEach(admin => {
                        const row = document.createElement('tr');

                        row.innerHTML = `
                            <td>${admin.role.name}</td>
                            <td>${admin.name}</td>
                            <td>${admin.email}</td>
                            <td>${admin.contactNumber}</td>
                            <td class="text-center">
                                <button class="btn btn-primary btn-sm modify-btn" data-id="${admin._id}" style="background: #08addc;">
                                    <i class="fas fa-edit"></i>&nbsp;Modify
                                </button>
                            </td>
                        `;

                        tableBody.appendChild(row);
                    });

                    // Add event listeners for modify buttons
                    document.querySelectorAll('.modify-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const adminId = e.currentTarget.getAttribute('data-id');
                            // Populate ModifyAdminModal with admin data
                            populateModifyModal(adminId);
                        });
                    });
                } else {
                    alert(`Error: ${admins.message}`);
                }
            } catch (err) {
                console.error(err);
                alert('Failed to fetch admin data.');
            }
        });

        async function populateModifyModal(adminId) {
            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`http://localhost:5001/api/auth/admins/${adminId}`, {
                    method: 'GET',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                    },
                });

                const admin = await response.json();

                if (response.ok) {
                    // Populate modal fields
                    document.querySelector('#ModifyAdmin [name="name"]').value = admin.name;
                    document.querySelector('#ModifyAdmin [name="email"]').value = admin.email;
                    document.querySelector('#ModifyAdmin [name="contactNumber"]').value = admin.contactNumber;
                    // Password fields should remain empty
                    document.querySelector('#ModifyAdmin [name="password"]').value = '';
                    document.querySelector('#ModifyAdmin [name="selectRole"]').value = admin.role.name;
                    
                    // Set admin ID for submission
                    document.querySelector('#ModifyAdmin').setAttribute('data-id', admin._id);

                    // Show the modal
                    const modifyModal = new bootstrap.Modal(document.getElementById('ModifyAdminModal'));
                    modifyModal.show();
                } else {
                    alert(`Error: ${admin.message}`);
                }
            } catch (err) {
                console.error(err);
                alert('Failed to fetch admin data.');
            }
        }

        // Handle Create Admin Form Submission
        document.querySelector('#CreateAdminModal .btn-primary').addEventListener('click', async () => {
            const form = document.getElementById('CreateAdmin');
            const formData = new FormData(form);
            const data = {
                name: formData.get('name'),
                email: formData.get('email'),
                contactNumber: formData.get('contactNumber'),
                password: formData.get('password'),
                role: formData.get('SelectRole'),
            };

            const token = localStorage.getItem('token');

            try {
                const response = await fetch('http://localhost:5001/api/auth/create', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                    },
                    body: JSON.stringify(data),
                });

                const result = await response.json();

                if (response.ok) {
                    alert('Admin created successfully.');
                    // Refresh the admin table or fetch data again
                } else {
                    alert(`Error: ${result.message}`);
                }
            } catch (err) {
                console.error(err);
                alert('Failed to create admin.');
            }
        });

        // Handle Modify Admin Form Submission
        document.querySelector('#ModifyAdminModal .btn-primary').addEventListener('click', async () => {
            const form = document.getElementById('ModifyAdmin');
            const adminId = form.getAttribute('data-id');
            const formData = new FormData(form);
            const data = {
                name: formData.get('name') || undefined,
                email: formData.get('email') || undefined,
                contactNumber: formData.get('contactNumber') || undefined,
                password: formData.get('password') || undefined,
                role: formData.get('selectRole') || undefined,
            };

            const token = localStorage.getItem('token');

            try {
                const response = await fetch(`http://localhost:5001/api/auth/modify/${adminId}`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                    },
                    body: JSON.stringify(data),
                });

                const result = await response.json();

                if (response.ok) {
                    alert('Admin updated successfully.');
                    // Refresh the admin table or fetch data again
                } else {
                    alert(`Error: ${result.message}`);
                }
            } catch (err) {
                console.error(err);
                alert('Failed to update admin.');
            }
        });
    </script>
</body>

</html>